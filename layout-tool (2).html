<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>置き場レイアウト作成ツール</title>
  <style>
    /* 全体のスタイル */
    :root {
      --primary-color: #1B6C8C;
      --secondary-color: #BF8136;
      --light-color: #F2E8E4;
      --dark-color: #260101;
      --accent-color: #BF5656;
      --grid-color: #e0e0e0;
      --grid-size: 20px;
      --scale-factor: 2; /* 2cm = 1px の変換率 */
      --group-border-color: rgba(27, 108, 140, 0.6);
      --group-bg-color: rgba(27, 108, 140, 0.1);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
      background-color: #f8f9fa;
    }
    
    /* ヘッダー */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background-color: var(--primary-color);
      color: white;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    
    header h1 {
      font-size: 1.8rem;
      font-weight: 600;
    }
    
    .tool-controls {
      display: flex;
      gap: 15px;
    }
    
    button {
      background-color: var(--secondary-color);
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
      font-weight: 500;
    }
    
    button:hover {
      background-color: #a26b2e;
    }
    
    button i {
      margin-right: 5px;
    }
    
    /* メインコンテンツ */
    .main-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    
    /* サイドバー */
    .sidebar {
      width: 320px;
      background-color: white;
      padding: 20px;
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    
    .sidebar h2 {
      margin-bottom: 15px;
      color: var(--primary-color);
      font-size: 1.4rem;
    }
    
    .tab-container {
      display: flex;
      margin-bottom: 15px;
      border-bottom: 1px solid #ddd;
    }
    
    .tab {
      padding: 8px 15px;
      flex: 1;
      text-align: center;
      cursor: pointer;
      background-color: #f8f9fa;
      transition: all 0.2s;
    }
    
    .tab.active {
      background-color: var(--primary-color);
      color: white;
      font-weight: bold;
    }
    
    .tab-content {
      display: none;
      flex-direction: column;
      gap: 15px;
    }
    
    .tab-content.active {
      display: flex;
    }
    
    /* フォーム要素 */
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #333;
    }
    
    .form-group input, .form-group select {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .color-preview {
      width: 25px;
      height: 25px;
      display: inline-block;
      border: 1px solid #ccc;
      vertical-align: middle;
      margin-left: 10px;
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      margin-top: 5px;
    }
    
    .checkbox-group input {
      width: auto;
      margin-right: 8px;
    }
    
    .dimension-group {
      display: flex;
      gap: 10px;
    }
    
    .dimension-group .form-group {
      flex: 1;
    }
    
    /* オブジェクトリスト */
    .object-list {
      margin-top: 20px;
      border: 1px solid #ddd;
      border-radius: 5px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .object-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background-color 0.2s;
    }
    
    .object-item:hover {
      background-color: #f5f5f5;
    }
    
    .object-item:last-child {
      border-bottom: none;
    }
    
    .object-info {
      flex: 1;
    }
    
    .object-name {
      font-weight: 500;
      margin-bottom: 3px;
    }
    
    .object-meta {
      font-size: 12px;
      color: #666;
    }
    
    .object-actions {
      display: flex;
      gap: 8px;
    }
    
    .object-actions button {
      padding: 4px 8px;
      font-size: 12px;
      background-color: #f0f0f0;
      color: #333;
    }
    
    .object-actions button:hover {
      background-color: #e0e0e0;
    }
    
    /* キャンバスエリア */
    .canvas-container {
      flex: 1;
      position: relative;
      overflow: auto;
      background-color: white;
    }
    
    .canvas-wrapper {
      position: relative;
    }
    
    .canvas {
      position: relative;
      width: 3000px;
      height: 2000px;
      background-color: white;
      background-image: 
        linear-gradient(var(--grid-color) 1px, transparent 1px),
        linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
      background-size: var(--grid-size) var(--grid-size);
      overflow: hidden;
      margin-left: 40px;
      margin-top: 40px;
    }
    
    /* グリッド目盛り */
    .grid-ruler-x {
      position: absolute;
      top: 0;
      left: 40px;
      right: 0;
      height: 40px;
      background: #f9f9f9;
      border-bottom: 1px solid #ddd;
      overflow: hidden;
    }
    
    .grid-ruler-y {
      position: absolute;
      top: 40px;
      left: 0;
      width: 40px;
      bottom: 0;
      background: #f9f9f9;
      border-right: 1px solid #ddd;
      overflow: hidden;
    }
    
    .ruler-corner {
      position: absolute;
      top: 0;
      left: 0;
      width: 40px;
      height: 40px;
      background: #f0f0f0;
      border-right: 1px solid #ddd;
      border-bottom: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #666;
    }
    
    .ruler-mark-x {
      position: absolute;
      top: 0;
      width: 1px;
      height: 8px;
      background-color: #999;
      bottom: 0;
    }
    
    .ruler-mark-y {
      position: absolute;
      left: 0;
      height: 1px;
      width: 8px;
      background-color: #999;
      right: 0;
    }
    
    .ruler-text-x {
      position: absolute;
      bottom: 5px;
      transform: translateX(-50%);
      font-size: 10px;
      color: #666;
    }
    
    .ruler-text-y {
      position: absolute;
      right: 5px;
      transform: translateY(-50%);
      font-size: 10px;
      color: #666;
    }
    
    /* キャンバス上のオブジェクト */
    .layout-object {
      position: absolute;
      border: 1px solid #333;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: move;
      user-select: none;
      font-size: 12px;
      text-align: center;
      overflow: hidden;
      background-color: rgba(255, 255, 255, 0.7);
      box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
      transition: box-shadow 0.2s;
      z-index: 5;
    }
    
    .layout-object.fixed {
      cursor: not-allowed;
      background-image: repeating-linear-gradient(
        45deg,
        rgba(0, 0, 0, 0.05),
        rgba(0, 0, 0, 0.05) 10px,
        rgba(255, 255, 255, 0.05) 10px,
        rgba(255, 255, 255, 0.05) 20px
      );
    }
    
    .layout-object:hover {
      box-shadow: 3px 3px 8px rgba(0, 0, 0, 0.3);
      z-index: 10;
    }
    
    .layout-object.selected {
      border: 2px solid var(--primary-color);
      z-index: 100;
    }
    
    .object-label {
      font-weight: bold;
      padding: 4px;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }
    
    .object-dimension {
      font-size: 10px;
      color: #666;
      margin-top: 2px;
    }

    /* グループ表示 */
    .layout-group {
      position: absolute;
      border: 2px dashed var(--group-border-color);
      background-color: var(--group-bg-color);
      z-index: 1;
    }

    .group-name {
      position: absolute;
      top: -20px;
      left: 10px;
      background-color: var(--primary-color);
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      white-space: nowrap;
    }
    
    /* 距離測定ライン */
    .measurement-line {
      position: absolute;
      height: 1.5px;
      background-color: rgba(191, 86, 86, 0.5);
      z-index: 50;
      pointer-events: none;
    }
    
    .measurement-line:hover {
      background-color: var(--accent-color);
      height: 2px;
      z-index: 55;
    }
    
    .measurement-label {
      position: absolute;
      background-color: rgba(191, 86, 86, 0.7);
      color: white;
      padding: 1px 4px;
      border-radius: 3px;
      font-size: 10px;
      z-index: 51;
      pointer-events: none;
      transform: translate(-50%, -50%);
      white-space: nowrap;
    }
    
    .measurement-label:hover {
      background-color: var(--accent-color);
      padding: 2px 6px;
      font-size: 12px;
      z-index: 56;
    }
    
    .measurements-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 40;
    }
    
    /* ツールバー */
    .toolbar {
      display: flex;
      align-items: center;
      padding: 10px;
      background-color: #f0f0f0;
      border-bottom: 1px solid #ddd;
    }
    
    .toolbar button {
      margin-right: 10px;
    }

    .toolbar-group {
      display: flex;
      align-items: center;
      border-right: 1px solid #ddd;
      padding-right: 10px;
      margin-right: 10px;
    }
    
    .toolbar-info {
      margin-left: auto;
      padding: 5px 10px;
      background-color: var(--light-color);
      border-radius: 5px;
      font-size: 12px;
      color: #666;
    }
    
    /* 切替スイッチ */
    .switch-container {
      display: flex;
      align-items: center;
      margin-right: 15px;
    }
    
    .switch-label {
      margin-right: 8px;
      font-size: 14px;
    }
    
    .switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 20px;
    }
    
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 34px;
    }
    
    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }
    
    input:checked + .slider {
      background-color: var(--primary-color);
    }
    
    input:checked + .slider:before {
      transform: translateX(20px);
    }

    /* 選択ボックス */
    .selection-box {
      position: absolute;
      border: 1px dashed var(--primary-color);
      background-color: rgba(27, 108, 140, 0.1);
      z-index: 200;
      pointer-events: none;
    }
    
    /* ズームコントロール */
    .zoom-controls {
      position: absolute;
      bottom: 20px;
      right: 20px;
      display: flex;
      gap: 10px;
      background-color: white;
      padding: 5px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    
    .zoom-controls button {
      width: 36px;
      height: 36px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 16px;
    }
    
    /* レスポンシブ対応 */
    @media (max-width: 768px) {
      .main-container {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        max-height: 300px;
      }
    }
    
    /* モーダル */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      width: 400px;
      max-width: 90%;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    
    .modal h2 {
      margin-bottom: 15px;
      color: var(--primary-color);
    }
    
    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }

    /* グループモーダル */
    #groupModal .color-options {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }

    #groupModal .color-option {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
    }

    #groupModal .color-option.selected {
      border-color: black;
    }

    /* エクスポートモーダル */
    .export-options {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 20px;
    }

    .export-option {
      display: flex;
      align-items: center;
      padding: 10px;
      border: 1px solid #eee;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .export-option:hover {
      background-color: #f5f5f5;
    }

    .export-option.selected {
      background-color: var(--light-color);
      border-color: var(--primary-color);
    }

    .export-option i {
      font-size: 24px;
      margin-right: 10px;
      color: var(--primary-color);
    }

    .export-option-content {
      flex: 1;
    }

    .export-option-title {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .export-option-desc {
      display: block;
      font-size: 12px;
      color: #666;
    }

    .preview-container {
      max-height: 300px;
      overflow: auto;
      border: 1px solid #ddd;
      margin-top: 15px;
      padding: 10px;
      text-align: center;
    }

    /* 共有モーダル */
    .share-options {
      margin-bottom: 20px;
    }

    .share-url {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #f9f9f9;
      font-size: 14px;
    }

    .share-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .share-qrcode {
      display: block;
      margin: 0 auto;
      max-width: 200px;
      max-height: 200px;
    }

    .share-social {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 15px;
    }

    .share-social button {
      width: 40px;
      height: 40px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      font-size: 20px;
    }

    .share-mode {
      display: flex;
      gap: 15px;
      margin: 15px 0;
    }

    .share-mode-option {
      flex: 1;
      padding: 10px;
      text-align: center;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
    }

    .share-mode-option.selected {
      background-color: var(--light-color);
      border-color: var(--primary-color);
      font-weight: bold;
    }
    
    /* トースト通知 */
    .toast-container {
      position: fixed;
      bottom: 20px;
      left: 20px;
      z-index: 1000;
    }
    
    .toast {
      background-color: #333;
      color: white;
      padding: 10px 15px;
      border-radius: 4px;
      margin-bottom: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      animation: fadeIn 0.3s, fadeOut 0.3s 2.7s;
      opacity: 0;
      animation-fill-mode: forwards;
    }
    
    .toast.success {
      background-color: #28a745;
    }
    
    .toast.error {
      background-color: var(--accent-color);
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes fadeOut {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(-20px); }
    }
  </style>
  <!-- Font Awesome CDNの読み込み -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <!-- ヘッダー -->
  <header>
    <h1><i class="fas fa-map-location-dot"></i> 置き場レイアウト作成ツール</h1>
    <div class="tool-controls">
      <button id="saveBtn"><i class="fas fa-save"></i> 保存</button>
      <button id="loadBtn"><i class="fas fa-folder-open"></i> 読込</button>
      <button id="exportBtn"><i class="fas fa-file-export"></i> エクスポート</button>
      <button id="shareBtn"><i class="fas fa-share-alt"></i> 共有</button>
      <button id="clearBtn"><i class="fas fa-trash-alt"></i> クリア</button>
    </div>
  </header>
  
  <!-- ツールバー -->
  <div class="toolbar">
    <div class="toolbar-group">
      <button id="selectModeBtn" class="mode-btn active"><i class="fas fa-mouse-pointer"></i> 選択</button>
      <button id="multiSelectModeBtn" class="mode-btn"><i class="fas fa-object-group"></i> 複数選択</button>
    </div>

    <div class="toolbar-group">
      <button id="createGroupBtn" disabled><i class="fas fa-object-group"></i> グループ化</button>
      <button id="ungroupBtn" disabled><i class="fas fa-object-ungroup"></i> グループ解除</button>
    </div>

    <div class="switch-container">
      <span class="switch-label">距離表示:</span>
      <label class="switch">
        <input type="checkbox" id="showDistancesToggle" checked>
        <span class="slider"></span>
      </label>
    </div>
    <div class="toolbar-info">
      オブジェクト数: <span id="objectCount">0</span> | グループ数: <span id="groupCount">0</span>
    </div>
  </div>
  
  <!-- メインコンテンツ -->
  <div class="main-container">
    <!-- サイドバー -->
    <div class="sidebar">
      <div class="tab-container">
        <div class="tab active" data-tab="object-form">オブジェクト追加</div>
        <div class="tab" data-tab="object-list">オブジェクト一覧</div>
        <div class="tab" data-tab="group-list">グループ一覧</div>
      </div>
      
      <!-- オブジェクト追加フォーム -->
      <div class="tab-content active" id="object-form">
        <h2>新規オブジェクト</h2>
        
        <div class="form-group">
          <label for="objectName">名前</label>
          <input type="text" id="objectName" placeholder="例: 作業台1">
        </div>
        
        <div class="dimension-group">
          <div class="form-group">
            <label for="objectWidth">幅 (cm)</label>
            <input type="number" id="objectWidth" min="10" value="100">
          </div>
          
          <div class="form-group">
            <label for="objectHeight">奥行き (cm)</label>
            <input type="number" id="objectHeight" min="10" value="100">
          </div>
        </div>
        
        <div class="form-group">
          <label for="objectColor">色 <span id="colorPreview" class="color-preview"></span></label>
          <input type="color" id="objectColor" value="#1B6C8C">
        </div>
        
        <div class="form-group">
          <div class="checkbox-group">
            <input type="checkbox" id="isFixed">
            <label for="isFixed">固定オブジェクト（移動不可）</label>
          </div>
        </div>
        
        <button id="addObjectBtn"><i class="fas fa-plus"></i> オブジェクト追加</button>
      </div>
      
      <!-- オブジェクト一覧 -->
      <div class="tab-content" id="object-list">
        <h2>配置済みオブジェクト</h2>
        <div class="object-list" id="objectListContainer">
          <!-- オブジェクトリストはJSで動的に生成 -->
        </div>
      </div>

      <!-- グループ一覧 -->
      <div class="tab-content" id="group-list">
        <h2>グループ一覧</h2>
        <div class="object-list" id="groupListContainer">
          <!-- グループリストはJSで動的に生成 -->
        </div>
      </div>
    </div>
    
    <!-- キャンバスエリア -->
    <div class="canvas-container">
      <div class="canvas-wrapper">
        <!-- 目盛りの角 -->
        <div class="ruler-corner">
          <div>1グリッド = 20cm</div>
          <div>1cm = 1px</div>
        </div>
        
        <!-- X軸目盛り -->
        <div class="grid-ruler-x" id="rulerX">
          <!-- 目盛りはJSで動的に生成 -->
        </div>
        
        <!-- Y軸目盛り -->
        <div class="grid-ruler-y" id="rulerY">
          <!-- 目盛りはJSで動的に生成 -->
        </div>
        
        <!-- キャンバス -->
        <div class="canvas" id="layoutCanvas">
          <!-- オブジェクトはJSで動的に生成 -->
          <div class="measurements-container" id="measurementsContainer">
            <!-- 距離測定線はJSで動的に生成 -->
          </div>
        </div>
      </div>
      
      <!-- ズームコントロール -->
      <div class="zoom-controls">
        <button id="zoomInBtn"><i class="fas fa-plus"></i></button>
        <button id="zoomOutBtn"><i class="fas fa-minus"></i></button>
        <button id="zoomResetBtn"><i class="fas fa-expand"></i></button>
      </div>
    </div>
  </div>
  
  <!-- 保存モーダル -->
  <div class="modal-overlay" id="saveModal">
    <div class="modal">
      <h2>レイアウトを保存</h2>
      <div class="form-group">
        <label for="layoutName">レイアウト名</label>
        <input type="text" id="layoutName" placeholder="例: 倉庫レイアウト案1">
      </div>
      <div class="modal-buttons">
        <button id="cancelSaveBtn">キャンセル</button>
        <button id="confirmSaveBtn">保存</button>
      </div>
    </div>
  </div>
  
  <!-- 読込モーダル -->
  <div class="modal-overlay" id="loadModal">
    <div class="modal">
      <h2>レイアウトを読込</h2>
      <div id="savedLayouts">
        <!-- 保存済みレイアウトはJSで動的に生成 -->
      </div>
      <div class="modal-buttons">
        <button id="cancelLoadBtn">キャンセル</button>
      </div>
    </div>
  </div>

  <!-- グループ作成モーダル -->
  <div class="modal-overlay" id="groupModal">
    <div class="modal">
      <h2>グループを作成</h2>
      <div class="form-group">
        <label for="groupName">グループ名</label>
        <input type="text" id="groupName" placeholder="例: 作業エリア1">
      </div>
      <div class="form-group">
        <label>グループの色</label>
        <div class="color-options" id="groupColorOptions">
          <div class="color-option selected" style="background-color: #1B6C8C;" data-color="#1B6C8C"></div>
          <div class="color-option" style="background-color: #BF8136;" data-color="#BF8136"></div>
          <div class="color-option" style="background-color: #BF5656;" data-color="#BF5656"></div>
          <div class="color-option" style="background-color: #5BBF56;" data-color="#5BBF56"></div>
          <div class="color-option" style="background-color: #565BBF;" data-color="#565BBF"></div>
          <div class="color-option" style="background-color: #B05BBF;" data-color="#B05BBF"></div>
        </div>
      </div>
      <div class="modal-buttons">
        <button id="cancelGroupBtn">キャンセル</button>
        <button id="confirmGroupBtn">グループ作成</button>
      </div>
    </div>
  </div>
  
  <!-- エクスポートモーダル -->
  <div class="modal-overlay" id="exportModal">
    <div class="modal">
      <h2>エクスポート</h2>
      <div class="export-options">
        <div class="export-option" id="exportImage" data-type="image">
          <i class="fas fa-image"></i>
          <div class="export-option-content">
            <span class="export-option-title">画像として保存</span>
            <span class="export-option-desc">PNG形式で画像を保存</span>
          </div>
        </div>
        <div class="export-option" id="exportPDF" data-type="pdf">
          <i class="fas fa-file-pdf"></i>
          <div class="export-option-content">
            <span class="export-option-title">PDFとして保存</span>
            <span class="export-option-desc">印刷用PDFで出力</span>
          </div>
        </div>
        <div class="export-option" id="exportJSON" data-type="json">
          <i class="fas fa-file-code"></i>
          <div class="export-option-content">
            <span class="export-option-title">JSONデータ</span>
            <span class="export-option-desc">編集可能なデータ形式</span>
          </div>
        </div>
        <div class="export-option" id="exportCSV" data-type="csv">
          <i class="fas fa-file-csv"></i>
          <div class="export-option-content">
            <span class="export-option-title">CSV出力</span>
            <span class="export-option-desc">表計算ソフト用データ</span>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label for="exportFileName">ファイル名</label>
        <input type="text" id="exportFileName" placeholder="例: レイアウト図面">
      </div>
      <div id="previewContainer" class="preview-container" style="display: none;">
        <!-- プレビュー画像はJSで動的に生成 -->
      </div>
      <div class="modal-buttons">
        <button id="cancelExportBtn">キャンセル</button>
        <button id="downloadExportBtn" style="display: none;">ダウンロード</button>
      </div>
    </div>
  </div>
  
  <!-- 共有モーダル -->
  <div class="modal-overlay" id="shareModal">
    <div class="modal">
      <h2>レイアウトを共有</h2>
      <div class="share-options">
        <div class="share-mode">
          <div class="share-mode-option selected" data-mode="view">閲覧専用</div>
          <div class="share-mode-option" data-mode="edit">編集可能</div>
        </div>
        <p>以下のリンクを共有することで、このレイアウトを他の人と共有できます：</p>
        <input type="text" id="shareURL" class="share-url" readonly>
        <div class="share-buttons">
          <button id="copyShareURLBtn"><i class="fas fa-copy"></i> URLをコピー</button>
          <button id="generateQRBtn"><i class="fas fa-qrcode"></i> QRコード表示</button>
        </div>
        <div id="qrCodeContainer" style="display: none;">
          <img id="qrCodeImage" class="share-qrcode">
        </div>
        <div class="share-social">
          <button class="share-twitter" style="background-color: #1DA1F2;"><i class="fab fa-twitter"></i></button>
          <button class="share-facebook" style="background-color: #4267B2;"><i class="fab fa-facebook-f"></i></button>
          <button class="share-line" style="background-color: #06C755;"><i class="fab fa-line"></i></button>
          <button class="share-mail" style="background-color: #EA4335;"><i class="fas fa-envelope"></i></button>
        </div>
      </div>
      <div class="modal-buttons">
        <button id="cancelShareBtn">閉じる</button>
      </div>
    </div>
  </div>
  
  <!-- トースト通知コンテナ -->
  <div class="toast-container" id="toastContainer">
    <!-- 通知はJSで動的に生成 -->
  </div>
  
  <!-- 外部ライブラリの読み込み -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>

  <script>
    // アプリケーションの主要クラス
    class LayoutApp {
      constructor() {
        // DOM要素
        this.canvas = document.getElementById('layoutCanvas');
        this.objectListContainer = document.getElementById('objectListContainer');
        this.groupListContainer = document.getElementById('groupListContainer');
        this.saveModal = document.getElementById('saveModal');
        this.loadModal = document.getElementById('loadModal');
        this.groupModal = document.getElementById('groupModal');
        this.exportModal = document.getElementById('exportModal');
        this.shareModal = document.getElementById('shareModal');
        this.toastContainer = document.getElementById('toastContainer');
        this.rulerX = document.getElementById('rulerX');
        this.rulerY = document.getElementById('rulerY');
        this.measurementsContainer = document.getElementById('measurementsContainer');
        this.objectCountDisplay = document.getElementById('objectCount');
        this.groupCountDisplay = document.getElementById('groupCount');
        this.previewContainer = document.getElementById('previewContainer');
        this.shareURLInput = document.getElementById('shareURL');
        this.qrCodeContainer = document.getElementById('qrCodeContainer');
        this.qrCodeImage = document.getElementById('qrCodeImage');
        this.exportFileName = document.getElementById('exportFileName');
        
        // フォーム要素
        this.objectNameInput = document.getElementById('objectName');
        this.objectWidthInput = document.getElementById('objectWidth');
        this.objectHeightInput = document.getElementById('objectHeight');
        this.objectColorInput = document.getElementById('objectColor');
        this.isFixedInput = document.getElementById('isFixed');
        this.colorPreview = document.getElementById('colorPreview');
        this.showDistancesToggle = document.getElementById('showDistancesToggle');
        this.groupNameInput = document.getElementById('groupName');
        this.groupColorOptions = document.getElementById('groupColorOptions');
        
        // ツールバーボタン
        this.selectModeBtn = document.getElementById('selectModeBtn');
        this.multiSelectModeBtn = document.getElementById('multiSelectModeBtn');
        this.createGroupBtn = document.getElementById('createGroupBtn');
        this.ungroupBtn = document.getElementById('ungroupBtn');
        
        // 状態管理
        this.objects = [];
        this.groups = [];
        this.selectedObject = null;
        this.selectedObjects = [];
        this.selectedGroup = null;
        this.isDragging = false;
        this.isMultiSelecting = false;
        this.startMultiSelectPos = { x: 0, y: 0 };
        this.currentMultiSelectPos = { x: 0, y: 0 };
        this.selectionBox = null;
        this.dragOffsetX = 0;
        this.dragOffsetY = 0;
        this.currentScale = 1;
        this.gridSize = 20; // ピクセル単位のグリッドサイズ
        this.cmPerGrid = 20; // 1グリッドあたりのcm数 (1グリッド=20cm)
        this.pixelsPerCm = this.gridSize / this.cmPerGrid; // 1cmあたりのピクセル数
        this.measurementLines = [];
        this.measurementLabels = [];
        this.selectedGroupColor = '#1B6C8C';
        this.currentMode = 'select';
        this.exportType = null;
        this.shareMode = 'view';
        
        // 初期化
        this.initEventListeners();
        this.updateColorPreview();
        this.initTabs();
        this.initRulers();
        this.initSelectionBox();
        this.loadFromURLIfNeeded();
      }
      
      // URLからレイアウトを読み込む（共有機能）
      loadFromURLIfNeeded() {
        const params = new URLSearchParams(window.location.search);
        const layoutData = params.get('data');
        const mode = params.get('mode') || 'view';
        
        if (layoutData) {
          try {
            // データを復号化して読み込む
            const decompressedData = LZString.decompressFromEncodedURIComponent(layoutData);
            const parsedData = JSON.parse(decompressedData);
            
            // オブジェクトとグループを復元
            this.clearLayoutWithoutConfirmation();
            
            // グループを先に復元
            if (parsedData.groups) {
              this.groups = parsedData.groups;
              this.groups.forEach(group => this.renderGroup(group));
            }
            
            // オブジェクトを復元
            if (parsedData.objects) {
              this.objects = parsedData.objects;
              this.objects.forEach(object => this.renderObject(object));
            }
            
            // 表示を更新
            this.updateObjectList();
            this.updateGroupList();
            this.updateCounts();
            this.updateAllMeasurements();
            
            // 閲覧専用モードの場合
            if (mode === 'view') {
              this.disableEditing();
              this.showToast('閲覧専用モードでレイアウトを表示しています', 'info');
            } else {
              this.showToast('共有されたレイアウトを読み込みました', 'success');
            }
          } catch (error) {
            console.error('共有データの読み込みに失敗しました', error);
            this.showToast('共有データの読み込みに失敗しました', 'error');
          }
        }
      }
      
      // 編集機能を無効化（閲覧専用モード用）
      disableEditing() {
        document.querySelectorAll('.toolbar button, .sidebar button').forEach(btn => {
          btn.disabled = true;
        });
        this.canvas.classList.add('view-only');
      }
      
      // 選択ボックスの初期化
      initSelectionBox() {
        this.selectionBox = document.createElement('div');
        this.selectionBox.className = 'selection-box';
        this.selectionBox.style.display = 'none';
        this.canvas.appendChild(this.selectionBox);
      }
      
      // 目盛りの初期化
      initRulers() {
        // X軸目盛りをクリア
        this.rulerX.innerHTML = '';
        
        // Y軸目盛りをクリア
        this.rulerY.innerHTML = '';
        
        // X軸目盛りの作成
        const canvasWidth = this.canvas.offsetWidth;
        const xMarks = Math.floor(canvasWidth / this.gridSize);
        
        for (let i = 0; i <= xMarks; i++) {
          const mark = document.createElement('div');
          mark.className = 'ruler-mark-x';
          mark.style.left = `${i * this.gridSize}px`;
          
          if (i % 5 === 0) { // 5目盛りごとに数値を表示
            mark.style.height = '12px';
            
            const text = document.createElement('div');
            text.className = 'ruler-text-x';
            text.style.left = `${i * this.gridSize}px`;
            text.textContent = i * this.cmPerGrid; // 実寸表示(cm)
            this.rulerX.appendChild(text);
          }
          
          this.rulerX.appendChild(mark);
        }
        
        // Y軸目盛りの作成
        const canvasHeight = this.canvas.offsetHeight;
        const yMarks = Math.floor(canvasHeight / this.gridSize);
        
        for (let i = 0; i <= yMarks; i++) {
          const mark = document.createElement('div');
          mark.className = 'ruler-mark-y';
          mark.style.top = `${i * this.gridSize}px`;
          
          if (i % 5 === 0) {
            mark.style.width = '12px';
            
            const text = document.createElement('div');
            text.className = 'ruler-text-y';
            text.style.top = `${i * this.gridSize}px`;
            text.textContent = i * this.cmPerGrid;
            this.rulerY.appendChild(text);
          }
          
          this.rulerY.appendChild(mark);
        }
      }
      
      // イベントリスナー初期化
      initEventListeners() {
        // オブジェクト追加ボタン
        document.getElementById('addObjectBtn').addEventListener('click', () => this.addObject());
        
        // 色選択の更新
        this.objectColorInput.addEventListener('input', () => this.updateColorPreview());
        
        // キャンバスのイベント
        this.canvas.addEventListener('mousedown', (e) => this.handleCanvasMouseDown(e));
        document.addEventListener('mousemove', (e) => this.handleDocumentMouseMove(e));
        document.addEventListener('mouseup', () => this.handleDocumentMouseUp());
        
        // モード切替ボタン
        this.selectModeBtn.addEventListener('click', () => this.setMode('select'));
        this.multiSelectModeBtn.addEventListener('click', () => this.setMode('multiSelect'));
        
        // グループ操作ボタン
        this.createGroupBtn.addEventListener('click', () => this.showGroupModal());
        this.ungroupBtn.addEventListener('click', () => this.ungroupSelected());
        
        // ズームコントロール
        document.getElementById('zoomInBtn').addEventListener('click', () => this.zoomIn());
        document.getElementById('zoomOutBtn').addEventListener('click', () => this.zoomOut());
        document.getElementById('zoomResetBtn').addEventListener('click', () => this.zoomReset());
        
        // 距離表示の切り替え
        this.showDistancesToggle.addEventListener('change', () => {
          if (this.showDistancesToggle.checked) {
            this.measurementsContainer.style.display = 'block';
            this.updateAllMeasurements();
          } else {
            this.measurementsContainer.style.display = 'none';
          }
        });
        
        // 保存/読込ボタン
        document.getElementById('saveBtn').addEventListener('click', () => this.showSaveModal());
        document.getElementById('loadBtn').addEventListener('click', () => this.showLoadModal());
        document.getElementById('exportBtn').addEventListener('click', () => this.showExportModal());
        document.getElementById('shareBtn').addEventListener('click', () => this.showShareModal());
        document.getElementById('clearBtn').addEventListener('click', () => this.clearLayout());
        
        // グループモーダルのイベント
        document.querySelectorAll('#groupColorOptions .color-option').forEach(option => {
          option.addEventListener('click', () => {
            document.querySelectorAll('#groupColorOptions .color-option').forEach(opt => opt.classList.remove('selected'));
            option.classList.add('selected');
            this.selectedGroupColor = option.dataset.color;
          });
        });
        
        // モーダルボタン
        document.getElementById('cancelSaveBtn').addEventListener('click', () => this.hideSaveModal());
        document.getElementById('confirmSaveBtn').addEventListener('click', () => this.saveLayout());
        document.getElementById('cancelLoadBtn').addEventListener('click', () => this.hideLoadModal());
        document.getElementById('cancelGroupBtn').addEventListener('click', () => this.hideGroupModal());
        document.getElementById('confirmGroupBtn').addEventListener('click', () => this.createGroup());
        document.getElementById('cancelExportBtn').addEventListener('click', () => this.hideExportModal());
        document.getElementById('downloadExportBtn').addEventListener('click', () => this.downloadExport());
        document.getElementById('cancelShareBtn').addEventListener('click', () => this.hideShareModal());
        
        // エクスポートオプションの選択
        document.querySelectorAll('.export-option').forEach(option => {
          option.addEventListener('click', () => {
            document.querySelectorAll('.export-option').forEach(opt => opt.classList.remove('selected'));
            option.classList.add('selected');
            this.exportType = option.dataset.type;
            this.generateExportPreview();
          });
        });
        
        // 共有モードの選択
        document.querySelectorAll('.share-mode-option').forEach(option => {
          option.addEventListener('click', () => {
            document.querySelectorAll('.share-mode-option').forEach(opt => opt.classList.remove('selected'));
            option.classList.add('selected');
            this.shareMode = option.dataset.mode;
            this.generateShareURL();
          });
        });
        
        // 共有機能ボタン
        document.getElementById('copyShareURLBtn').addEventListener('click', () => this.copyShareURL());
        document.getElementById('generateQRBtn').addEventListener('click', () => this.generateQRCode());
        
        // SNS共有ボタン
        document.querySelector('.share-twitter').addEventListener('click', () => this.shareToSNS('twitter'));
        document.querySelector('.share-facebook').addEventListener('click', () => this.shareToSNS('facebook'));
        document.querySelector('.share-line').addEventListener('click', () => this.shareToSNS('line'));
        document.querySelector('.share-mail').addEventListener('click', () => this.shareToSNS('mail'));
        
        // ウィンドウリサイズ時に目盛りを更新
        window.addEventListener('resize', () => {
          this.initRulers();
        });
      }
      
      // 操作モードの設定
      setMode(mode) {
        this.currentMode = mode;
        
        // ボタンのアクティブ状態を更新
        document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
        
        if (mode === 'select') {
          this.selectModeBtn.classList.add('active');
          this.clearMultiSelection();
        } else if (mode === 'multiSelect') {
          this.multiSelectModeBtn.classList.add('active');
          if (this.selectedObject) {
            document.getElementById(`object-${this.selectedObject.id}`).classList.remove('selected');
            this.selectedObject = null;
          }
        }
      }
      
      // タブ切り替え初期化
      initTabs() {
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        tabs.forEach(tab => {
          tab.addEventListener('click', () => {
            // アクティブタブの切り替え
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            // タブコンテンツの切り替え
            tabContents.forEach(content => content.classList.remove('active'));
            const tabId = tab.dataset.tab;
            document.getElementById(tabId).classList.add('active');
          });
        });
      }
      
      // 色プレビューの更新
      updateColorPreview() {
        this.colorPreview.style.backgroundColor = this.objectColorInput.value;
      }
      
      // オブジェクト追加
      addObject() {
        const name = this.objectNameInput.value.trim() || `オブジェクト${this.objects.length + 1}`;
        const width = parseInt(this.objectWidthInput.value) || 100;
        const height = parseInt(this.objectHeightInput.value) || 100;
        const color = this.objectColorInput.value;
        const isFixed = this.isFixedInput.checked;
        
        // オブジェクト作成
        const object = {
          id: Date.now().toString(),
          name,
          width,
          height,
          color,
          isFixed,
          x: 100,
          y: 100,
          groupId: null // グループID（初期はnull）
        };
        
        this.objects.push(object);
        this.renderObject(object);
        this.updateObjectList();
        this.updateCounts();
        this.resetForm();
        
        // 距離測定を更新
        this.updateAllMeasurements();
        
        this.showToast('オブジェクトを追加しました', 'success');
      }
      
      // グループモーダルを表示
      showGroupModal() {
        if (this.selectedObjects.length < 2) {
          this.showToast('2つ以上のオブジェクトを選択してください', 'error');
          return;
        }
        
        this.groupNameInput.value = `グループ${this.groups.length + 1}`;
        this.groupModal.style.display = 'flex';
      }
      
      // グループモーダルを非表示
      hideGroupModal() {
        this.groupModal.style.display = 'none';
      }
      
      // グループ作成
      createGroup() {
        if (this.selectedObjects.length < 2) {
          this.showToast('2つ以上のオブジェクトを選択してください', 'error');
          return;
        }
        
        const name = this.groupNameInput.value.trim() || `グループ${this.groups.length + 1}`;
        const color = this.selectedGroupColor;
        
        // 選択されたオブジェクトの範囲を計算
        let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
        
        this.selectedObjects.forEach(object => {
          const objMinX = object.x;
          const objMinY = object.y;
          const objMaxX = object.x + (object.width * this.pixelsPerCm);
          const objMaxY = object.y + (object.height * this.pixelsPerCm);
          
          minX = Math.min(minX, objMinX);
          minY = Math.min(minY, objMinY);
          maxX = Math.max(maxX, objMaxX);
          maxY = Math.max(maxY, objMaxY);
        });
        
        // グループオブジェクト作成
        const group = {
          id: Date.now().toString(),
          name,
          color,
          x: minX,
          y: minY,
          width: (maxX - minX) / this.pixelsPerCm,
          height: (maxY - minY) / this.pixelsPerCm,
          objectIds: this.selectedObjects.map(obj => obj.id)
        };
        
        // オブジェクトにグループIDを設定
        this.selectedObjects.forEach(object => {
          const index = this.objects.findIndex(obj => obj.id === object.id);
          if (index !== -1) {
            this.objects[index].groupId = group.id;
          }
        });
        
        this.groups.push(group);
        this.renderGroup(group);
        
        this.updateObjectList();
        this.updateGroupList();
        this.updateCounts();
        this.clearMultiSelection();
        this.hideGroupModal();
        
        this.showToast(`グループ「${name}」を作成しました`, 'success');
      }
      
      // グループ表示
      renderGroup(group) {
        const groupElement = document.createElement('div');
        groupElement.id = `group-${group.id}`;
        groupElement.className = 'layout-group';
        groupElement.style.left = `${group.x}px`;
        groupElement.style.top = `${group.y}px`;
        groupElement.style.width = `${group.width * this.pixelsPerCm}px`;
        groupElement.style.height = `${group.height * this.pixelsPerCm}px`;
        groupElement.style.borderColor = group.color;
        groupElement.style.backgroundColor = `${group.color}20`; // 色に透明度を追加
        
        const nameLabel = document.createElement('div');
        nameLabel.className = 'group-name';
        nameLabel.textContent = group.name;
        nameLabel.style.backgroundColor = group.color;
        groupElement.appendChild(nameLabel);
        
        // グループをクリックしたときの処理
        groupElement.addEventListener('click', (e) => {
          if (this.currentMode === 'select' && !this.isDragging) {
            e.stopPropagation();
            this.selectGroup(group.id);
          }
        });
        
        this.canvas.insertBefore(groupElement, this.canvas.firstChild);
      }
      
      // グループ選択
      selectGroup(groupId) {
        if (this.selectedGroup) {
          document.getElementById(`group-${this.selectedGroup.id}`).classList.remove('selected');
        }
        
        if (this.selectedObject) {
          document.getElementById(`object-${this.selectedObject.id}`).classList.remove('selected');
          this.selectedObject = null;
        }
        
        this.clearMultiSelection();
        
        const group = this.groups.find(g => g.id === groupId);
        if (group) {
          this.selectedGroup = group;
          document.getElementById(`group-${groupId}`).classList.add('selected');
          this.ungroupBtn.disabled = false;
        }
      }
      
      // グループ解除
      ungroupSelected() {
        if (!this.selectedGroup) return;
        
        const groupId = this.selectedGroup.id;
        
        // グループに属するオブジェクトのグループIDをnullに設定
        this.objects.forEach(object => {
          if (object.groupId === groupId) {
            object.groupId = null;
          }
        });
        
        // グループを削除
        const groupIndex = this.groups.findIndex(g => g.id === groupId);
        if (groupIndex !== -1) {
          this.groups.splice(groupIndex, 1);
        }
        
        // グループ要素を削除
        const groupElement = document.getElementById(`group-${groupId}`);
        if (groupElement) {
          groupElement.remove();
        }
        
        this.selectedGroup = null;
        this.ungroupBtn.disabled = true;
        
        this.updateObjectList();
        this.updateGroupList();
        this.updateCounts();
        
        this.showToast('グループを解除しました', 'success');
      }
      
      // オブジェクトのDOM要素作成
      renderObject(object) {
        const objectElement = document.createElement('div');
        objectElement.id = `object-${object.id}`;
        objectElement.className = `layout-object${object.isFixed ? ' fixed' : ''}`;
        objectElement.style.width = `${object.width * this.pixelsPerCm}px`;
        objectElement.style.height = `${object.height * this.pixelsPerCm}px`;
        objectElement.style.backgroundColor = object.color;
        objectElement.style.left = `${object.x}px`;
        objectElement.style.top = `${object.y}px`;
        
        // オブジェクトの内容
        const label = document.createElement('div');
        label.className = 'object-label';
        label.textContent = object.name;
        objectElement.appendChild(label);
        
        const dimension = document.createElement('div');
        dimension.className = 'object-dimension';
        dimension.textContent = `${object.width}×${object.height}cm`;
        objectElement.appendChild(dimension);
        
        this.canvas.appendChild(objectElement);
      }
      
      // オブジェクトリストの更新
      updateObjectList() {
        this.objectListContainer.innerHTML = '';
        
        if (this.objects.length === 0) {
          const emptyMsg = document.createElement('div');
          emptyMsg.className = 'object-item';
          emptyMsg.textContent = 'オブジェクトがありません';
          this.objectListContainer.appendChild(emptyMsg);
          return;
        }
        
        // グループなしのオブジェクトを表示
        const ungroupedObjects = this.objects.filter(obj => !obj.groupId);
        
        ungroupedObjects.forEach(object => {
          const item = this.createObjectListItem(object);
          this.objectListContainer.appendChild(item);
        });
        
        // グループごとにオブジェクトを表示
        this.groups.forEach(group => {
          const groupHeader = document.createElement('div');
          groupHeader.className = 'object-item';
          groupHeader.style.fontWeight = 'bold';
          groupHeader.style.backgroundColor = `${group.color}20`;
          groupHeader.innerHTML = `<i class="fas fa-object-group"></i> ${group.name} (${group.objectIds.length}件)`;
          this.objectListContainer.appendChild(groupHeader);
          
          // グループ内のオブジェクトを表示
          this.objects
            .filter(obj => obj.groupId === group.id)
            .forEach(object => {
              const item = this.createObjectListItem(object);
              item.style.paddingLeft = '20px';
              this.objectListContainer.appendChild(item);
            });
        });
      }
      
      // グループリストの更新
      updateGroupList() {
        this.groupListContainer.innerHTML = '';
        
        if (this.groups.length === 0) {
          const emptyMsg = document.createElement('div');
          emptyMsg.className = 'object-item';
          emptyMsg.textContent = 'グループがありません';
          this.groupListContainer.appendChild(emptyMsg);
          return;
        }
        
        this.groups.forEach(group => {
          const item = document.createElement('div');
          item.className = 'object-item';
          
          const info = document.createElement('div');
          info.className = 'object-info';
          
          const name = document.createElement('div');
          name.className = 'object-name';
          name.innerHTML = `<i class="fas fa-object-group" style="color: ${group.color}"></i> ${group.name}`;
          
          const meta = document.createElement('div');
          meta.className = 'object-meta';
          meta.textContent = `オブジェクト数: ${group.objectIds.length}`;
          
          info.appendChild(name);
          info.appendChild(meta);
          
          const actions = document.createElement('div');
          actions.className = 'object-actions';
          
          const selectBtn = document.createElement('button');
          selectBtn.innerHTML = '<i class="fas fa-search"></i>';
          selectBtn.title = '選択';
          selectBtn.addEventListener('click', () => this.selectGroup(group.id));
          
          const deleteBtn = document.createElement('button');
          deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
          deleteBtn.title = '削除';
          deleteBtn.addEventListener('click', () => this.deleteGroup(group.id));
          
          actions.appendChild(selectBtn);
          actions.appendChild(deleteBtn);
          
          item.appendChild(info);
          item.appendChild(actions);
          
          this.groupListContainer.appendChild(item);
        });
      }
      
      // オブジェクトリストアイテムの作成
      createObjectListItem(object) {
        const item = document.createElement('div');
        item.className = 'object-item';
        
        const info = document.createElement('div');
        info.className = 'object-info';
        
        const name = document.createElement('div');
        name.className = 'object-name';
        name.textContent = object.name;
        
        const meta = document.createElement('div');
        meta.className = 'object-meta';
        meta.textContent = `${object.width}×${object.height}cm · ${object.isFixed ? '固定' : '稼働'}`;
        
        info.appendChild(name);
        info.appendChild(meta);
        
        const actions = document.createElement('div');
        actions.className = 'object-actions';
        
        const selectBtn = document.createElement('button');
        selectBtn.innerHTML = '<i class="fas fa-search"></i>';
        selectBtn.title = '選択';
        selectBtn.addEventListener('click', () => this.selectObjectById(object.id));
        
        const deleteBtn = document.createElement('button');
        deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
        deleteBtn.title = '削除';
        deleteBtn.addEventListener('click', () => this.deleteObject(object.id));
        
        actions.appendChild(selectBtn);
        actions.appendChild(deleteBtn);
        
        item.appendChild(info);
        item.appendChild(actions);
        
        return item;
      }
      
      // IDによるオブジェクト選択
      selectObjectById(id) {
        // 現在の選択をクリア
        if (this.selectedObject) {
          document.getElementById(`object-${this.selectedObject.id}`).classList.remove('selected');
        }
        
        if (this.selectedGroup) {
          document.getElementById(`group-${this.selectedGroup.id}`).classList.remove('selected');
          this.selectedGroup = null;
          this.ungroupBtn.disabled = true;
        }
        
        this.clearMultiSelection();
        
        // 新たに選択
        const object = this.objects.find(obj => obj.id === id);
        if (object) {
          this.selectedObject = object;
          document.getElementById(`object-${id}`).classList.add('selected');
          
          // オブジェクトが表示範囲内に入るようにスクロール
          const objectElement = document.getElementById(`object-${id}`);
          objectElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }
      
      // オブジェクト削除
      deleteObject(id) {
        // グループからオブジェクトを削除
        const object = this.objects.find(obj => obj.id === id);
        if (object && object.groupId) {
          const groupIndex = this.groups.findIndex(g => g.id === object.groupId);
          if (groupIndex !== -1) {
            // グループからオブジェクトIDを削除
            this.groups[groupIndex].objectIds = this.groups[groupIndex].objectIds.filter(objId => objId !== id);
            
            // グループが空になった場合はグループも削除
            if (this.groups[groupIndex].objectIds.length === 0) {
              document.getElementById(`group-${this.groups[groupIndex].id}`).remove();
              this.groups.splice(groupIndex, 1);
            } else {
              // グループのサイズを再計算
              this.recalculateGroupBounds(this.groups[groupIndex]);
            }
          }
        }
        
        // オブジェクトを削除
        const index = this.objects.findIndex(obj => obj.id === id);
        if (index !== -1) {
          this.objects.splice(index, 1);
        }
        
        // DOM要素を削除
        const objectElement = document.getElementById(`object-${id}`);
        if (objectElement) {
          objectElement.remove();
        }
        
        // 選択状態の更新
        if (this.selectedObject && this.selectedObject.id === id) {
          this.selectedObject = null;
        }
        
        this.selectedObjects = this.selectedObjects.filter(obj => obj.id !== id);
        this.updateCreateGroupButtonState();
        
        this.updateObjectList();
        this.updateGroupList();
        this.updateCounts();
        this.updateAllMeasurements();
        
        this.showToast('オブジェクトを削除しました');
      }
      
      // グループ削除
      deleteGroup(groupId) {
        // グループに属するオブジェクトのグループIDを解除
        this.objects.forEach(object => {
          if (object.groupId === groupId) {
            object.groupId = null;
          }
        });
        
        // グループを削除
        const groupIndex = this.groups.findIndex(g => g.id === groupId);
        if (groupIndex !== -1) {
          this.groups.splice(groupIndex, 1);
        }
        
        // DOM要素を削除
        const groupElement = document.getElementById(`group-${groupId}`);
        if (groupElement) {
          groupElement.remove();
        }
        
        // 選択状態の更新
        if (this.selectedGroup && this.selectedGroup.id === groupId) {
          this.selectedGroup = null;
          this.ungroupBtn.disabled = true;
        }
        
        this.updateObjectList();
        this.updateGroupList();
        this.updateCounts();
        
        this.showToast('グループを削除しました');
      }
      
      // グループの範囲を再計算
      recalculateGroupBounds(group) {
        const groupObjects = this.objects.filter(obj => obj.groupId === group.id);
        if (groupObjects.length === 0) return;
        
        let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
        
        groupObjects.forEach(object => {
          const objMinX = object.x;
          const objMinY = object.y;
          const objMaxX = object.x + (object.width * this.pixelsPerCm);
          const objMaxY = object.y + (object.height * this.pixelsPerCm);
          
          minX = Math.min(minX, objMinX);
          minY = Math.min(minY, objMinY);
          maxX = Math.max(maxX, objMaxX);
          maxY = Math.max(maxY, objMaxY);
        });
        
        // グループの位置とサイズを更新
        group.x = minX;
        group.y = minY;
        group.width = (maxX - minX) / this.pixelsPerCm;
        group.height = (maxY - minY) / this.pixelsPerCm;
        
        // DOM要素を更新
        const groupElement = document.getElementById(`group-${group.id}`);
        if (groupElement) {
          groupElement.style.left = `${group.x}px`;
          groupElement.style.top = `${group.y}px`;
          groupElement.style.width = `${group.width * this.pixelsPerCm}px`;
          groupElement.style.height = `${group.height * this.pixelsPerCm}px`;
        }
      }
      
      // オブジェクト数表示の更新
      updateCounts() {
        this.objectCountDisplay.textContent = this.objects.length;
        this.groupCountDisplay.textContent = this.groups.length;
      }
      
      // フォームのリセット
      resetForm() {
        this.objectNameInput.value = '';
        this.isFixedInput.checked = false;
      }
      
      // キャンバス上のマウスダウンイベント
      handleCanvasMouseDown(e) {
        if (this.currentMode === 'select') {
          this.handleSelectModeMouseDown(e);
        } else if (this.currentMode === 'multiSelect') {
          this.handleMultiSelectModeMouseDown(e);
        }
      }
      
      // 選択モードでのマウスダウン処理
      handleSelectModeMouseDown(e) {
        const target = e.target;
        
        // オブジェクトをクリックした場合
        if (target.closest('.layout-object')) {
          const objectElement = target.closest('.layout-object');
          const id = objectElement.id.replace('object-', '');
          const object = this.objects.find(obj => obj.id === id);
          
          if (object) {
            this.isDragging = !object.isFixed; // 固定オブジェクトは動かせない
            
            if (this.isDragging) {
              this.dragOffsetX = e.clientX - objectElement.offsetLeft;
              this.dragOffsetY = e.clientY - objectElement.offsetTop;
            }
            
            // 既存の選択を解除
            if (this.selectedObject) {
              document.getElementById(`object-${this.selectedObject.id}`).classList.remove('selected');
            }
            
            if (this.selectedGroup) {
              document.getElementById(`group-${this.selectedGroup.id}`).classList.remove('selected');
              this.selectedGroup = null;
              this.ungroupBtn.disabled = true;
            }
            
            // 新たに選択
            this.selectedObject = object;
            objectElement.classList.add('selected');
          }
        } else if (!target.closest('.layout-group')) {
          // キャンバスの空白部分または既にグループがハンドリングした場合
          if (this.selectedObject) {
            document.getElementById(`object-${this.selectedObject.id}`).classList.remove('selected');
            this.selectedObject = null;
          }
          
          if (this.selectedGroup) {
            document.getElementById(`group-${this.selectedGroup.id}`).classList.remove('selected');
            this.selectedGroup = null;
            this.ungroupBtn.disabled = true;
          }
        }
      }
      
      // 複数選択モードでのマウスダウン処理
      handleMultiSelectModeMouseDown(e) {
        // 選択ボックスの開始位置を設定
        const rect = this.canvas.getBoundingClientRect();
        this.startMultiSelectPos = {
          x: e.clientX - rect.left,
          y: e.clientY - rect.top
        };
        
        this.currentMultiSelectPos = { ...this.startMultiSelectPos };
        
        // 選択ボックスを表示
        this.selectionBox.style.display = 'block';
        this.selectionBox.style.left = `${this.startMultiSelectPos.x}px`;
        this.selectionBox.style.top = `${this.startMultiSelectPos.y}px`;
        this.selectionBox.style.width = '0px';
        this.selectionBox.style.height = '0px';
        
        this.isDragging = true;
      }
      
      // ドキュメント全体のマウス移動イベント
      handleDocumentMouseMove(e) {
        if (this.currentMode === 'select') {
          this.handleSelectModeMouseMove(e);
        } else if (this.currentMode === 'multiSelect' && this.isDragging) {
          this.handleMultiSelectModeMouseMove(e);
        }
      }
      
      // 選択モードでのマウス移動処理
      handleSelectModeMouseMove(e) {
        if (this.isDragging && this.selectedObject && !this.selectedObject.isFixed) {
          const newX = e.clientX - this.dragOffsetX;
          const newY = e.clientY - this.dragOffsetY;
          
          // オブジェクトの位置を更新
          const objectElement = document.getElementById(`object-${this.selectedObject.id}`);
          objectElement.style.left = `${newX}px`;
          objectElement.style.top = `${newY}px`;
          
          // データも更新
          this.selectedObject.x = newX;
          this.selectedObject.y = newY;
          
          // グループに属する場合はグループの範囲も更新
          if (this.selectedObject.groupId) {
            const group = this.groups.find(g => g.id === this.selectedObject.groupId);
            if (group) {
              this.recalculateGroupBounds(group);
            }
          }
          
          // 移動中のオブジェクトに関連する距離測定を更新
          if (this.showDistancesToggle.checked) {
            this.updateMeasurementsForObject(this.selectedObject.id);
          }
        }
      }
      
      // 複数選択モードでのマウス移動処理
      handleMultiSelectModeMouseMove(e) {
        const rect = this.canvas.getBoundingClientRect();
        this.currentMultiSelectPos = {
          x: e.clientX - rect.left,
          y: e.clientY - rect.top
        };
        
        // 選択ボックスのサイズと位置を更新
        const left = Math.min(this.startMultiSelectPos.x, this.currentMultiSelectPos.x);
        const top = Math.min(this.startMultiSelectPos.y, this.currentMultiSelectPos.y);
        const width = Math.abs(this.currentMultiSelectPos.x - this.startMultiSelectPos.x);
        const height = Math.abs(this.currentMultiSelectPos.y - this.startMultiSelectPos.y);
        
        this.selectionBox.style.left = `${left}px`;
        this.selectionBox.style.top = `${top}px`;
        this.selectionBox.style.width = `${width}px`;
        this.selectionBox.style.height = `${height}px`;
      }
      
      // ドキュメント全体のマウスアップイベント
      handleDocumentMouseUp() {
        if (this.currentMode === 'select') {
          if (this.isDragging) {
            this.isDragging = false;
            // ドラッグ終了時に全体の測定を更新
            if (this.showDistancesToggle.checked) {
              this.updateAllMeasurements();
            }
          }
        } else if (this.currentMode === 'multiSelect') {
          if (this.isDragging) {
            this.isDragging = false;
            this.selectionBox.style.display = 'none';
            
            // 選択ボックス内のオブジェクトを選択
            this.selectObjectsInBox(
              parseFloat(this.selectionBox.style.left),
              parseFloat(this.selectionBox.style.top),
              parseFloat(this.selectionBox.style.width),
              parseFloat(this.selectionBox.style.height)
            );
          }
        }
      }
      
      // 選択ボックス内のオブジェクトを選択
      selectObjectsInBox(left, top, width, height) {
        // 前回の選択をクリア
        this.clearMultiSelection();
        
        // 選択ボックスの範囲
        const selectionRect = {
          left: left,
          top: top,
          right: left + width,
          bottom: top + height
        };
        
        // 範囲内のオブジェクトを選択
        this.objects.forEach(object => {
          const objectRect = {
            left: object.x,
            top: object.y,
            right: object.x + (object.width * this.pixelsPerCm),
            bottom: object.y + (object.height * this.pixelsPerCm)
          };
          
          // 矩形が重なっている場合
          if (
            objectRect.left < selectionRect.right &&
            objectRect.right > selectionRect.left &&
            objectRect.top < selectionRect.bottom &&
            objectRect.bottom > selectionRect.top
          ) {
            this.selectedObjects.push(object);
            document.getElementById(`object-${object.id}`).classList.add('selected');
          }
        });
        
        // グループ化ボタンの状態を更新
        this.updateCreateGroupButtonState();
      }
      
      // 複数選択をクリア
      clearMultiSelection() {
        this.selectedObjects.forEach(object => {
          const element = document.getElementById(`object-${object.id}`);
          if (element) {
            element.classList.remove('selected');
          }
        });
        
        this.selectedObjects = [];
        this.updateCreateGroupButtonState();
      }
      
      // グループ化ボタンの状態を更新
      updateCreateGroupButtonState() {
        this.createGroupBtn.disabled = this.selectedObjects.length < 2;
      }
      
      // すべてのオブジェクト間の距離測定を更新
      updateAllMeasurements() {
        if (!this.showDistancesToggle.checked) return;
        
        // 測定コンテナをクリア
        this.clearAllMeasurements();
        
        // 2つ以上のオブジェクトがない場合は測定不要
        if (this.objects.length < 2) return;
        
        // 全オブジェクトペアの組み合わせを作成して距離測定
        for (let i = 0; i < this.objects.length; i++) {
          for (let j = i + 1; j < this.objects.length; j++) {
            this.measureDistanceBetweenObjects(this.objects[i], this.objects[j]);
          }
        }
      }
      
      // 特定のオブジェクトに関連する距離測定を更新
      updateMeasurementsForObject(objectId) {
        if (!this.showDistancesToggle.checked) return;
        
        // オブジェクトに関連する測定をクリア
        this.clearMeasurementsForObject(objectId);
        
        // 対象オブジェクトと他のオブジェクトの距離を測定
        const targetObject = this.objects.find(obj => obj.id === objectId);
        if (!targetObject) return;
        
        this.objects.forEach(obj => {
          if (obj.id !== objectId) {
            this.measureDistanceBetweenObjects(targetObject, obj);
          }
        });
      }
      
      // 2つのオブジェクト間の距離を測定
      measureDistanceBetweenObjects(obj1, obj2) {
        // オブジェクトの中心座標を計算
        const center1 = {
          x: obj1.x + (obj1.width * this.pixelsPerCm) / 2,
          y: obj1.y + (obj1.height * this.pixelsPerCm) / 2
        };
        
        const center2 = {
          x: obj2.x + (obj2.width * this.pixelsPerCm) / 2,
          y: obj2.y + (obj2.height * this.pixelsPerCm) / 2
        };
        
        // 2点間の距離を計算（ピクセル単位）
        const dx = center2.x - center1.x;
        const dy = center2.y - center1.y;
        const distance = Math.sqrt(dx * dx + dy * dy);
        
        // 角度を計算
        const angle = Math.atan2(dy, dx) * 180 / Math.PI;
        
        // 測定線を作成
        const measurementLine = document.createElement('div');
        measurementLine.className = 'measurement-line';
        measurementLine.dataset.obj1 = obj1.id;
        measurementLine.dataset.obj2 = obj2.id;
        measurementLine.style.width = `${distance}px`;
        measurementLine.style.left = `${center1.x}px`;
        measurementLine.style.top = `${center1.y}px`;
        measurementLine.style.transformOrigin = '0 0';
        measurementLine.style.transform = `rotate(${angle}deg)`;
        
        this.measurementLines.push(measurementLine);
        this.measurementsContainer.appendChild(measurementLine);
        
        // 測定ラベルを作成（cm換算）
        const distanceCm = distance / this.pixelsPerCm;
        const measurementLabel = document.createElement('div');
        measurementLabel.className = 'measurement-label';
        measurementLabel.dataset.obj1 = obj1.id;
        measurementLabel.dataset.obj2 = obj2.id;
        measurementLabel.textContent = `${distanceCm.toFixed(0)} cm`;
        
        // ラベルの位置を線の中央に
        const labelX = center1.x + dx / 2;
        const labelY = center1.y + dy / 2;
        measurementLabel.style.left = `${labelX}px`;
        measurementLabel.style.top = `${labelY}px`;
        
        this.measurementLabels.push(measurementLabel);
        this.measurementsContainer.appendChild(measurementLabel);
      }
      
      // 全ての測定をクリア
      clearAllMeasurements() {
        this.measurementsContainer.innerHTML = '';
        this.measurementLines = [];
        this.measurementLabels = [];
      }
      
      // 特定のオブジェクトに関連する測定をクリア
      clearMeasurementsForObject(objectId) {
        // 対象オブジェクトに関連する線とラベルを削除
        const relatedLines = this.measurementLines.filter(
          line => line.dataset.obj1 === objectId || line.dataset.obj2 === objectId
        );
        
        const relatedLabels = this.measurementLabels.filter(
          label => label.dataset.obj1 === objectId || label.dataset.obj2 === objectId
        );
        
        relatedLines.forEach(line => {
          line.remove();
          this.measurementLines = this.measurementLines.filter(l => l !== line);
        });
        
        relatedLabels.forEach(label => {
          label.remove();
          this.measurementLabels = this.measurementLabels.filter(l => l !== label);
        });
      }
      
      // ズームイン
      zoomIn() {
        if (this.currentScale < 2) {
          this.currentScale += 0.1;
          this.applyZoom();
        }
      }
      
      // ズームアウト
      zoomOut() {
        if (this.currentScale > 0.5) {
          this.currentScale -= 0.1;
          this.applyZoom();
        }
      }
      
      // ズームリセット
      zoomReset() {
        this.currentScale = 1;
        this.applyZoom();
      }
      
      // ズーム適用
      applyZoom() {
        this.canvas.style.transform = `scale(${this.currentScale})`;
        this.canvas.style.transformOrigin = '0 0';
        
        // 目盛りも同じ比率でズーム
        this.rulerX.style.transform = `scaleX(${this.currentScale})`;
        this.rulerX.style.transformOrigin = '0 0';
        
        this.rulerY.style.transform = `scaleY(${this.currentScale})`;
        this.rulerY.style.transformOrigin = '0 0';
      }
      
      // 保存モーダル表示
      showSaveModal() {
        document.getElementById('layoutName').value = '';
        this.saveModal.style.display = 'flex';
      }
      
      // 保存モーダル非表示
      hideSaveModal() {
        this.saveModal.style.display = 'none';
      }
      
      // レイアウト保存
      saveLayout() {
        const name = document.getElementById('layoutName').value.trim();
        if (!name) {
          this.showToast('レイアウト名を入力してください', 'error');
          return;
        }
        
        const layoutData = {
          name,
          date: new Date().toLocaleString(),
          objects: [...this.objects],
          groups: [...this.groups],
          scale: this.currentScale,
          showDistances: this.showDistancesToggle.checked
        };
        
        // ローカルストレージから既存のレイアウトを取得
        let savedLayouts = JSON.parse(localStorage.getItem('layoutAppLayouts') || '[]');
        
        // 同名のレイアウトがあれば上書き
        const existingIndex = savedLayouts.findIndex(layout => layout.name === name);
        if (existingIndex !== -1) {
          savedLayouts[existingIndex] = layoutData;
        } else {
          savedLayouts.push(layoutData);
        }
        
        // ローカルストレージに保存
        localStorage.setItem('layoutAppLayouts', JSON.stringify(savedLayouts));
        
        this.hideSaveModal();
        this.showToast(`レイアウト「${name}」を保存しました`, 'success');
      }
      
      // 読込モーダル表示
      showLoadModal() {
        const savedLayouts = JSON.parse(localStorage.getItem('layoutAppLayouts') || '[]');
        const layoutsContainer = document.getElementById('savedLayouts');
        layoutsContainer.innerHTML = '';
        
        if (savedLayouts.length === 0) {
          layoutsContainer.innerHTML = '<p>保存されたレイアウトはありません</p>';
        } else {
          savedLayouts.forEach(layout => {
            const layoutItem = document.createElement('div');
            layoutItem.className = 'object-item';
            
            const info = document.createElement('div');
            info.appendChild(name);
            info.appendChild(meta);
            
            const actions = document.createElement('div');
            actions.className = 'object-actions';
            
            const loadBtn = document.createElement('button');
            loadBtn.textContent = '読込';
            loadBtn.addEventListener('click', () => this.loadLayout(layout));
            
            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
            deleteBtn.addEventListener('click', () => this.deleteSavedLayout(layout.name));
            
            actions.appendChild(loadBtn);
            actions.appendChild(deleteBtn);
            
            layoutItem.appendChild(info);
            layoutItem.appendChild(actions);
            
            layoutsContainer.appendChild(layoutItem);
          });
        }
        
        this.loadModal.style.display = 'flex';
      }
      
      // 読込モーダル非表示
      hideLoadModal() {
        this.loadModal.style.display = 'none';
      }
      
      // レイアウト読込
      loadLayout(layout) {
        // 既存のオブジェクトをクリア
        this.clearLayoutWithoutConfirmation();
        
        // グループを先に復元
        if (layout.groups) {
          this.groups = [...layout.groups];
          this.groups.forEach(group => this.renderGroup(group));
        }
        
        // オブジェクトを復元
        this.objects = [...layout.objects];
        this.objects.forEach(object => this.renderObject(object));
        
        // 選択状態をリセット
        this.selectedObject = null;
        this.selectedGroup = null;
        this.clearMultiSelection();
        
        // 距離表示設定の復元
        if (layout.showDistances !== undefined) {
          this.showDistancesToggle.checked = layout.showDistances;
          this.measurementsContainer.style.display = layout.showDistances ? 'block' : 'none';
        }
        
        // ズームを復元
        if (layout.scale) {
          this.currentScale = layout.scale;
          this.applyZoom();
        }
        
        this.updateObjectList();
        this.updateGroupList();
        this.updateCounts();
        this.updateAllMeasurements();
        this.hideLoadModal();
        this.showToast(`レイアウト「${layout.name}」を読み込みました`, 'success');
      }
      
      // 保存済みレイアウト削除
      deleteSavedLayout(name) {
        let savedLayouts = JSON.parse(localStorage.getItem('layoutAppLayouts') || '[]');
        savedLayouts = savedLayouts.filter(layout => layout.name !== name);
        localStorage.setItem('layoutAppLayouts', JSON.stringify(savedLayouts));
        
        this.showToast(`レイアウト「${name}」を削除しました`);
        this.showLoadModal(); // リスト更新
      }
      
      // レイアウトクリア
      clearLayout() {
        if (confirm('現在のレイアウトをクリアしますか？この操作は元に戻せません。')) {
          this.clearLayoutWithoutConfirmation();
        }
      }
      
      // 確認なしでレイアウトクリア（内部用）
      clearLayoutWithoutConfirmation() {
        // グループを削除
        this.groups.forEach(group => {
          const groupElement = document.getElementById(`group-${group.id}`);
          if (groupElement) {
            groupElement.remove();
          }
        });
        
        // キャンバス上のオブジェクトを削除
        this.objects.forEach(object => {
          const objectElement = document.getElementById(`object-${object.id}`);
          if (objectElement) {
            objectElement.remove();
          }
        });
        
        // データのクリア
        this.objects = [];
        this.groups = [];
        this.selectedObject = null;
        this.selectedGroup = null;
        this.selectedObjects = [];
        this.createGroupBtn.disabled = true;
        this.ungroupBtn.disabled = true;
        
        this.clearAllMeasurements();
        this.updateObjectList();
        this.updateGroupList();
        this.updateCounts();
      }
      
      // エクスポートモーダル表示
      showExportModal() {
        // ファイル名を設定
        this.exportFileName.value = `レイアウト_${new Date().toLocaleDateString().replace(/\//g, '-')}`;
        
        // エクスポートタイプをリセット
        this.exportType = null;
        document.querySelectorAll('.export-option').forEach(opt => opt.classList.remove('selected'));
        
        // プレビューをクリア
        this.previewContainer.innerHTML = '';
        this.previewContainer.style.display = 'none';
        
        document.getElementById('downloadExportBtn').style.display = 'none';
        
        this.exportModal.style.display = 'flex';
      }
      
      // エクスポートモーダル非表示
      hideExportModal() {
        this.exportModal.style.display = 'none';
      }
      
      // エクスポートプレビュー生成
      generateExportPreview() {
        if (!this.exportType) return;
        
        this.previewContainer.innerHTML = '<div>プレビューを生成中...</div>';
        this.previewContainer.style.display = 'block';
        
        const fileName = this.exportFileName.value.trim() || `レイアウト_${new Date().toLocaleDateString().replace(/\//g, '-')}`;
        
        switch (this.exportType) {
          case 'image':
            this.generateImagePreview();
            break;
          case 'pdf':
            this.previewContainer.innerHTML = '<div>PDFプレビューは利用できません。ダウンロードボタンをクリックしてPDFを生成してください。</div>';
            document.getElementById('downloadExportBtn').style.display = 'block';
            break;
          case 'json':
            this.generateJSONPreview();
            break;
          case 'csv':
            this.generateCSVPreview();
            break;
        }
      }
      
      // 画像プレビュー生成
      generateImagePreview() {
        const canvas = document.getElementById('layoutCanvas');
        
        html2canvas(canvas, {
          backgroundColor: 'white',
          scale: window.devicePixelRatio,
          logging: false
        }).then(canvas => {
          // プレビュー表示
          this.previewContainer.innerHTML = '';
          canvas.style.maxWidth = '100%';
          canvas.style.height = 'auto';
          this.previewContainer.appendChild(canvas);
          
          // ダウンロードボタンを表示
          document.getElementById('downloadExportBtn').style.display = 'block';
        }).catch(error => {
          console.error('Error generating image:', error);
          this.previewContainer.innerHTML = '<div>プレビューの生成に失敗しました</div>';
        });
      }
      
      // JSONプレビュー生成
      generateJSONPreview() {
        const layoutData = {
          objects: this.objects,
          groups: this.groups,
          date: new Date().toISOString()
        };
        
        const jsonString = JSON.stringify(layoutData, null, 2);
        
        // プレビュー表示
        const pre = document.createElement('pre');
        pre.style.maxHeight = '300px';
        pre.style.overflow = 'auto';
        pre.style.margin = '0';
        pre.style.padding = '10px';
        pre.style.backgroundColor = '#f5f5f5';
        pre.style.borderRadius = '4px';
        pre.style.fontSize = '12px';
        pre.textContent = jsonString;
        
        this.previewContainer.innerHTML = '';
        this.previewContainer.appendChild(pre);
        
        // ダウンロードボタンを表示
        document.getElementById('downloadExportBtn').style.display = 'block';
      }
      
      // CSVプレビュー生成
      generateCSVPreview() {
        // ヘッダー
        let csvContent = 'ID,名前,幅(cm),奥行き(cm),X座標,Y座標,色,固定,グループID\n';
        
        // オブジェクトデータ
        this.objects.forEach(obj => {
          csvContent += `${obj.id},"${obj.name}",${obj.width},${obj.height},${obj.x},${obj.y},"${obj.color}",${obj.isFixed},${obj.groupId || ''}\n`;
        });
        
        // グループデータがあれば別テーブルとして追加
        if (this.groups.length > 0) {
          csvContent += '\nグループID,グループ名,色,X座標,Y座標,幅(cm),奥行き(cm)\n';
          this.groups.forEach(group => {
            csvContent += `${group.id},"${group.name}","${group.color}",${group.x},${group.y},${group.width},${group.height}\n`;
          });
        }
        
        // プレビュー表示
        const pre = document.createElement('pre');
        pre.style.maxHeight = '300px';
        pre.style.overflow = 'auto';
        pre.style.margin = '0';
        pre.style.padding = '10px';
        pre.style.backgroundColor = '#f5f5f5';
        pre.style.borderRadius = '4px';
        pre.style.fontSize = '12px';
        pre.textContent = csvContent;
        
        this.previewContainer.innerHTML = '';
        this.previewContainer.appendChild(pre);
        
        // ダウンロードボタンを表示
        document.getElementById('downloadExportBtn').style.display = 'block';
      }
      
      // エクスポートダウンロード
      downloadExport() {
        if (!this.exportType) {
          this.showToast('エクスポート形式を選択してください', 'error');
          return;
        }
        
        const fileName = this.exportFileName.value.trim() || `レイアウト_${new Date().toLocaleDateString().replace(/\//g, '-')}`;
        
        switch (this.exportType) {
          case 'image':
            this.downloadImage(fileName);
            break;
          case 'pdf':
            this.downloadPDF(fileName);
            break;
          case 'json':
            this.downloadJSON(fileName);
            break;
          case 'csv':
            this.downloadCSV(fileName);
            break;
        }
      }
      
      // 画像ダウンロード
      downloadImage(fileName) {
        const canvas = document.getElementById('layoutCanvas');
        
        html2canvas(canvas, {
          backgroundColor: 'white',
          scale: window.devicePixelRatio,
          logging: false
        }).then(canvas => {
          // キャンバスをPNG形式に変換
          const dataURL = canvas.toDataURL('image/png');
          
          // ダウンロードリンクを作成
          const downloadLink = document.createElement('a');
          downloadLink.href = dataURL;
          downloadLink.download = `${fileName}.png`;
          
          // リンクをクリックしてダウンロード開始
          document.body.appendChild(downloadLink);
          downloadLink.click();
          document.body.removeChild(downloadLink);
          
          this.hideExportModal();
          this.showToast(`画像「${fileName}.png」をダウンロードしました`, 'success');
        }).catch(error => {
          console.error('Error generating image:', error);
          this.showToast('画像の生成に失敗しました', 'error');
        });
      }
      
      // PDFダウンロード
      downloadPDF(fileName) {
        const canvas = document.getElementById('layoutCanvas');
        
        html2canvas(canvas, {
          backgroundColor: 'white',
          scale: window.devicePixelRatio,
          logging: false
        }).then(canvas => {
          // キャンバスの幅と高さ
          const canvasWidth = canvas.width;
          const canvasHeight = canvas.height;
          
          // PDFのサイズを決定（A4サイズを基準）
          const pdfWidth = 210;  // A4の幅（mm）
          const pdfHeight = (canvasHeight * pdfWidth) / canvasWidth;
          
          // PDF生成
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF({
            orientation: pdfWidth > pdfHeight ? 'landscape' : 'portrait',
            unit: 'mm',
            format: [pdfWidth, pdfHeight]
          });
          
          // キャンバスイメージをPDFに追加
          const imgData = canvas.toDataURL('image/png');
          pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
          
          // PDFをダウンロード
          pdf.save(`${fileName}.pdf`);
          
          this.hideExportModal();
          this.showToast(`PDF「${fileName}.pdf」をダウンロードしました`, 'success');
        }).catch(error => {
          console.error('Error generating PDF:', error);
          this.showToast('PDFの生成に失敗しました', 'error');
        });
      }
      
      // JSONダウンロード
      downloadJSON(fileName) {
        const layoutData = {
          objects: this.objects,
          groups: this.groups,
          date: new Date().toISOString()
        };
        
        const jsonString = JSON.stringify(layoutData, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const downloadLink = document.createElement('a');
        downloadLink.href = url;
        downloadLink.download = `${fileName}.json`;
        
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
        
        URL.revokeObjectURL(url);
        
        this.hideExportModal();
        this.showToast(`JSON「${fileName}.json」をダウンロードしました`, 'success');
      }
      
      // CSVダウンロード
      downloadCSV(fileName) {
        // ヘッダー
        let csvContent = 'ID,名前,幅(cm),奥行き(cm),X座標,Y座標,色,固定,グループID\n';
        
        // オブジェクトデータ
        this.objects.forEach(obj => {
          csvContent += `${obj.id},"${obj.name}",${obj.width},${obj.height},${obj.x},${obj.y},"${obj.color}",${obj.isFixed},${obj.groupId || ''}\n`;
        });
        
        // グループデータがあれば別テーブルとして追加
        if (this.groups.length > 0) {
          csvContent += '\nグループID,グループ名,色,X座標,Y座標,幅(cm),奥行き(cm)\n';
          this.groups.forEach(group => {
            csvContent += `${group.id},"${group.name}","${group.color}",${group.x},${group.y},${group.width},${group.height}\n`;
          });
        }
        
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        
        const downloadLink = document.createElement('a');
        downloadLink.href = url;
        downloadLink.download = `${fileName}.csv`;
        
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
        
        URL.revokeObjectURL(url);
        
        this.hideExportModal();
        this.showToast(`CSV「${fileName}.csv」をダウンロードしました`, 'success');
      }
      
      // 共有モーダル表示
      showShareModal() {
        // 共有URLを生成
        this.generateShareURL();
        
        // QRコードを非表示にリセット
        this.qrCodeContainer.style.display = 'none';
        
        this.shareModal.style.display = 'flex';
      }
      
      // 共有モーダル非表示
      hideShareModal() {
        this.shareModal.style.display = 'none';
      }
      
      // 共有URL生成
      generateShareURL() {
        // レイアウトデータをJSON化
        const layoutData = {
          objects: this.objects,
          groups: this.groups,
          date: new Date().toISOString()
        };
        
        // データをJSON文字列に変換し、圧縮
        const jsonString = JSON.stringify(layoutData);
        const compressedData = LZString.compressToEncodedURIComponent(jsonString);
        
        // URLを生成（現在のページのベースURLに圧縮データとモードを追加）
        const baseUrl = window.location.href.split('?')[0];
        const shareUrl = `${baseUrl}?data=${compressedData}&mode=${this.shareMode}`;
        
        // 入力フィールドに設定
        this.shareURLInput.value = shareUrl;
      }
      
      // 共有URLをクリップボードにコピー
      copyShareURL() {
        this.shareURLInput.select();
        document.execCommand('copy');
        
        this.showToast('共有URLをクリップボードにコピーしました', 'success');
      }
      
      // QRコード生成
      generateQRCode() {
        const shareUrl = this.shareURLInput.value;
        
        // QRコードを生成
        QRCode.toDataURL(shareUrl, { errorCorrectionLevel: 'H' }, (err, url) => {
          if (err) {
            console.error('QRコードの生成に失敗しました', err);
            this.showToast('QRコードの生成に失敗しました', 'error');
            return;
          }
          
          // 画像要素に設定して表示
          this.qrCodeImage.src = url;
          this.qrCodeContainer.style.display = 'block';
        });
      }
      
      // SNSなどで共有
      shareToSNS(platform) {
        const shareUrl = encodeURIComponent(this.shareURLInput.value);
        const title = encodeURIComponent('置き場レイアウト作成ツール - 共有レイアウト');
        
        let url;
        
        switch (platform) {
          case 'twitter':
            url = `https://twitter.com/intent/tweet?url=${shareUrl}&text=${title}`;
            break;
          case 'facebook':
            url = `https://www.facebook.com/sharer/sharer.php?u=${shareUrl}`;
            break;
          case 'line':
            url = `https://social-plugins.line.me/lineit/share?url=${shareUrl}`;
            break;
          case 'mail':
            url = `mailto:?subject=${title}&body=${shareUrl}`;
            break;
          default:
            return;
        }
        
        window.open(url, '_blank');
      }
      
      // トースト通知表示
      showToast(message, type = '') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        this.toastContainer.appendChild(toast);
        
        // 一定時間後に削除
        setTimeout(() => {
          toast.remove();
        }, 3000);
      }
    }
    
    // アプリケーション初期化
    document.addEventListener('DOMContentLoaded', () => {
      const app = new LayoutApp();
    });
  </script>
</body>
</html>className = 'object-info';
            
